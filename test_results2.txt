============================= test session starts =============================
platform win32 -- Python 3.14.2, pytest-9.0.2, pluggy-1.6.0 -- C:\Users\asusu\AppData\Local\Python\pythoncore-3.14-64\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\asusu\CascadeProjects\flowlang\flowlang
configfile: pytest.ini
plugins: anyio-4.12.1
collecting ... collected 39 items

tests/test_grammar.py::test_parse_example_file FAILED                    [  2%]
tests/test_grammar.py::test_parse_min_program PASSED                     [  5%]
tests/test_concept_alignment.py::test_strict_team_typing PASSED          [  7%]
tests/test_concept_alignment.py::test_order_batch_processing FAILED      [ 10%]
tests/test_concept_alignment.py::test_checkpoint_report_handover PASSED  [ 12%]
tests/test_concept_alignment.py::test_orders_promotion PASSED            [ 15%]
tests/test_robustness.py::TestStateGrowth::test_deep_merge_list_growth PASSED [ 17%]
tests/test_robustness.py::TestStateGrowth::test_deep_merge_nested_growth PASSED [ 20%]
tests/test_robustness.py::TestStateGrowth::test_repeated_merge_state_size PASSED [ 23%]
tests/test_robustness.py::TestCRDTMerge::test_crdt_numeric_max PASSED    [ 25%]
tests/test_robustness.py::TestCRDTMerge::test_crdt_list_union PASSED     [ 28%]
tests/test_robustness.py::TestMalformedAIResponse::test_garbage_json_fallback PASSED [ 30%]
tests/test_robustness.py::TestMalformedAIResponse::test_missing_required_field PASSED [ 33%]
tests/test_robustness.py::TestMalformedAIResponse::test_wrong_type_in_response PASSED [ 35%]
tests/test_robustness.py::TestChainPropagation::test_propagation_decay_to_zero PASSED [ 38%]
tests/test_robustness.py::TestProcessTreePolicies::test_protected_node_collapse_blocked PASSED [ 41%]
tests/test_persistence.py::TestPersistence::test_manager_save_load PASSED [ 43%]
tests/test_persistence.py::TestPersistence::test_runtime_auto_save PASSED [ 46%]
tests/test_persistence.py::TestPersistence::test_resume_logic PASSED     [ 48%]
tests/test_human_gates.py::TestHumanGates::test_confirm_approved PASSED  [ 51%]
tests/test_human_gates.py::TestHumanGates::test_confirm_rejected PASSED  [ 53%]
tests/test_human_gates.py::TestHumanGates::test_confirm_auto_approve PASSED [ 56%]
tests/test_human_gates.py::TestHumanGates::test_dry_run_action_skipped PASSED [ 58%]
tests/test_schema_validation.py::TestJudgeResultValidation::test_valid_judge_response PASSED [ 61%]
tests/test_schema_validation.py::TestJudgeResultValidation::test_string_numbers_coerced PASSED [ 64%]
tests/test_schema_validation.py::TestJudgeResultValidation::test_score_out_of_range_fails PASSED [ 66%]
tests/test_schema_validation.py::TestJudgeResultValidation::test_invalid_string_fails PASSED [ 69%]
tests/test_schema_validation.py::TestSearchResultValidation::test_valid_search_response PASSED [ 71%]
tests/test_schema_validation.py::TestSearchResultValidation::test_single_string_coerced_to_list PASSED [ 74%]
tests/test_schema_validation.py::TestSearchResultValidation::test_none_becomes_empty_list PASSED [ 76%]
tests/test_schema_validation.py::TestTryResultValidation::test_valid_try_response PASSED [ 79%]
tests/test_schema_validation.py::TestTryResultValidation::test_missing_metrics_defaults PASSED [ 82%]
tests/test_schema_validation.py::TestCommunicateResultValidation::test_valid_ask_response PASSED [ 84%]
tests/test_schema_validation.py::TestCommunicateResultValidation::test_missing_history_defaults PASSED [ 87%]
tests/test_schema_validation.py::TestMapToTypedValue::test_valid_judge_creates_typed_value PASSED [ 89%]
tests/test_schema_validation.py::TestMapToTypedValue::test_invalid_judge_raises_error PASSED [ 92%]
tests/test_schema_validation.py::TestMapToTypedValue::test_raw_content_judge_fails PASSED [ 94%]
tests/test_schema_validation.py::TestMapToTypedValue::test_raw_content_ask_succeeds PASSED [ 97%]
tests/test_schema_validation.py::TestMapToTypedValue::test_search_with_valid_data PASSED [100%]

================================== FAILURES ===================================
___________________________ test_parse_example_file ___________________________
..\..\..\AppData\Local\Python\pythoncore-3.14-64\Lib\site-packages\lark\lexer.py:689: in lex
    yield lexer.next_token(lexer_state, parser_state)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\AppData\Local\Python\pythoncore-3.14-64\Lib\site-packages\lark\lexer.py:622: in next_token
    raise UnexpectedCharacters(lex_state.text.text, line_ctr.char_pos, line_ctr.line, line_ctr.column,
E   lark.exceptions.UnexpectedCharacters: No terminal matches '}' in the current parser context, at line 58 col 36
E   
E     node "Implement" { owner: "devA" };
E                                      ^
E   Expected one of: 
E   	* SEMICOLON
E   
E   Previous tokens: Token('STRING', '"devA"')

During handling of the above exception, another exception occurred:
flowlang\parser.py:20: in parse
    return parser.parse(text)
           ^^^^^^^^^^^^^^^^^^
..\..\..\AppData\Local\Python\pythoncore-3.14-64\Lib\site-packages\lark\lark.py:677: in parse
    return self.parser.parse(text, start=start, on_error=on_error)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\AppData\Local\Python\pythoncore-3.14-64\Lib\site-packages\lark\parser_frontends.py:131: in parse
    return self.parser.parse(stream, chosen_start, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\AppData\Local\Python\pythoncore-3.14-64\Lib\site-packages\lark\parsers\lalr_parser.py:42: in parse
    return self.parser.parse(lexer, start)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\AppData\Local\Python\pythoncore-3.14-64\Lib\site-packages\lark\parsers\lalr_parser.py:88: in parse
    return self.parse_from_state(parser_state)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\AppData\Local\Python\pythoncore-3.14-64\Lib\site-packages\lark\parsers\lalr_parser.py:111: in parse_from_state
    raise e
..\..\..\AppData\Local\Python\pythoncore-3.14-64\Lib\site-packages\lark\parsers\lalr_parser.py:100: in parse_from_state
    for token in state.lexer.lex(state):
                 ^^^^^^^^^^^^^^^^^^^^^^
..\..\..\AppData\Local\Python\pythoncore-3.14-64\Lib\site-packages\lark\lexer.py:698: in lex
    raise UnexpectedToken(token, e.allowed, state=parser_state, token_history=[last_token], terminals_by_name=self.root_lexer.terminals_by_name)
E   lark.exceptions.UnexpectedToken: Unexpected token Token('RBRACE', '}') at line 58, column 36.
E   Expected one of: 
E   	* SEMICOLON
E   Previous tokens: [Token('STRING', '"devA"')]

The above exception was the direct cause of the following exception:
tests\test_grammar.py:9: in test_parse_example_file
    tree = parse(p)
           ^^^^^^^^
flowlang\parser.py:22: in parse
    raise ParseError(str(e)) from e
E   flowlang.errors.ParseError: Unexpected token Token('RBRACE', '}') at line 58, column 36.
E   Expected one of: 
E   	* SEMICOLON
E   Previous tokens: [Token('STRING', '"devA"')]
_________________________ test_order_batch_processing _________________________
tests\test_concept_alignment.py:33: in test_order_batch_processing
    rt.run_flow("main")
flowlang\runtime.py:133: in run_flow
    self._execute_flow(flow)
flowlang\runtime.py:194: in _execute_flow
    self._exec_block(cp_node.find_data("local_stmt"), ctx)
flowlang\runtime.py:294: in _exec_block
    self._exec_action(child, ctx)
flowlang\runtime.py:1135: in _exec_action
    v = self._eval_expr(item.children[1], ctx)
                        ^^^^^^^^^^^^^^^^
E   IndexError: list index out of range
---------------------------- Captured stdout call -----------------------------
13:28:06 | [flow] Start 'main' with checkpoints: ['"run"']
13:28:06 | [checkpoint] -> "run"
{
    "name": "checkpoint:\"run\"",
    "context": {
        "trace_id": "0x3e1c24a72782bc999c33c58680f860a8",
        "span_id": "0x132c3adb0b187336",
        "trace_state": "[]"
    },
    "kind": "SpanKind.INTERNAL",
    "parent_id": "0xb29b5a369655b4ca",
    "start_time": "2026-02-14T12:28:06.644721Z",
    "end_time": "2026-02-14T12:28:06.647937Z",
    "status": {
        "status_code": "ERROR",
        "description": "IndexError: list index out of range"
    },
    "attributes": {},
    "events": [
        {
            "name": "exception",
            "timestamp": "2026-02-14T12:28:06.647909Z",
            "attributes": {
                "exception.type": "IndexError",
                "exception.message": "list index out of range",
                "exception.stacktrace": "Traceback (most recent call last):\n  File \"C:\\Users\\asusu\\AppData\\Local\\Python\\pythoncore-3.14-64\\Lib\\site-packages\\opentelemetry\\trace\\__init__.py\", line 589, in use_span\n    yield span\n  File \"C:\\Users\\asusu\\AppData\\Local\\Python\\pythoncore-3.14-64\\Lib\\site-packages\\opentelemetry\\sdk\\trace\\__init__.py\", line 1105, in start_as_current_span\n    yield span\n  File \"C:\\Users\\asusu\\CascadeProjects\\flowlang\\flowlang\\flowlang\\runtime.py\", line 194, in _execute_flow\n    self._exec_block(cp_node.find_data(\"local_stmt\"), ctx)\n    ~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\asusu\\CascadeProjects\\flowlang\\flowlang\\flowlang\\runtime.py\", line 294, in _exec_block\n    self._exec_action(child, ctx)\n    ~~~~~~~~~~~~~~~~~^^^^^^^^^^^^\n  File \"C:\\Users\\asusu\\CascadeProjects\\flowlang\\flowlang\\flowlang\\runtime.py\", line 1135, in _exec_action\n    v = self._eval_expr(item.children[1], ctx)\n                        ~~~~~~~~~~~~~^^^\nIndexError: list index out of range\n",
                "exception.escaped": "False"
            }
        }
    ],
    "links": [],
    "resource": {
        "attributes": {
            "telemetry.sdk.language": "python",
            "telemetry.sdk.name": "opentelemetry",
            "telemetry.sdk.version": "1.38.0",
            "service.name": "unknown_service"
        },
        "schema_url": ""
    }
}

{
    "name": "flow:main",
    "context": {
        "trace_id": "0x3e1c24a72782bc999c33c58680f860a8",
        "span_id": "0xb29b5a369655b4ca",
        "trace_state": "[]"
    },
    "kind": "SpanKind.INTERNAL",
    "parent_id": null,
    "start_time": "2026-02-14T12:28:06.643416Z",
    "end_time": "2026-02-14T12:28:06.649353Z",
    "status": {
        "status_code": "ERROR",
        "description": "IndexError: list index out of range"
    },
    "attributes": {},
    "events": [
        {
            "name": "exception",
            "timestamp": "2026-02-14T12:28:06.649325Z",
            "attributes": {
                "exception.type": "IndexError",
                "exception.message": "list index out of range",
                "exception.stacktrace": "Traceback (most recent call last):\n  File \"C:\\Users\\asusu\\AppData\\Local\\Python\\pythoncore-3.14-64\\Lib\\site-packages\\opentelemetry\\trace\\__init__.py\", line 589, in use_span\n    yield span\n  File \"C:\\Users\\asusu\\AppData\\Local\\Python\\pythoncore-3.14-64\\Lib\\site-packages\\opentelemetry\\sdk\\trace\\__init__.py\", line 1105, in start_as_current_span\n    yield span\n  File \"C:\\Users\\asusu\\CascadeProjects\\flowlang\\flowlang\\flowlang\\runtime.py\", line 133, in run_flow\n    self._execute_flow(flow)\n    ~~~~~~~~~~~~~~~~~~^^^^^^\n  File \"C:\\Users\\asusu\\CascadeProjects\\flowlang\\flowlang\\flowlang\\runtime.py\", line 194, in _execute_flow\n    self._exec_block(cp_node.find_data(\"local_stmt\"), ctx)\n    ~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\asusu\\CascadeProjects\\flowlang\\flowlang\\flowlang\\runtime.py\", line 294, in _exec_block\n    self._exec_action(child, ctx)\n    ~~~~~~~~~~~~~~~~~^^^^^^^^^^^^\n  File \"C:\\Users\\asusu\\CascadeProjects\\flowlang\\flowlang\\flowlang\\runtime.py\", line 1135, in _exec_action\n    v = self._eval_expr(item.children[1], ctx)\n                        ~~~~~~~~~~~~~^^^\nIndexError: list index out of range\n",
                "exception.escaped": "False"
            }
        }
    ],
    "links": [],
    "resource": {
        "attributes": {
            "telemetry.sdk.language": "python",
            "telemetry.sdk.name": "opentelemetry",
            "telemetry.sdk.version": "1.38.0",
            "service.name": "unknown_service"
        },
        "schema_url": ""
    }
}

============================== warnings summary ===============================
flowlang\ai_providers.py:23
  C:\Users\asusu\CascadeProjects\flowlang\flowlang\flowlang\ai_providers.py:23: FutureWarning: 
  
  All support for the `google.generativeai` package has ended. It will no longer be receiving 
  updates or bug fixes. Please switch to the `google.genai` package as soon as possible.
  See README for more details:
  
  https://github.com/google-gemini/deprecated-generative-ai-python/blob/main/README.md
  
    import google.generativeai as genai  # type: ignore

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/test_grammar.py::test_parse_example_file - flowlang.errors.ParseError: Unexpected token Token('RBRACE', '}') at line 58, column 36.
Expected one of: 
	* SEMICOLON
Previous tokens: [Token('STRING', '"devA"')]
FAILED tests/test_concept_alignment.py::test_order_batch_processing - IndexError: list index out of range
=================== 2 failed, 37 passed, 1 warning in 1.96s ===================
